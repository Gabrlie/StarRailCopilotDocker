name: Build and Push StarRailCopilot Docker Image

on:
  # å®šæ—¶è§¦å‘: æ¯å¤©åŒ—äº¬æ—¶é—´å‡Œæ™¨ 2:00 (UTC 18:00)
  schedule:
    - cron: '0 18 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # Push åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches:
      - main
    paths:
      - 'Dockerfile'
      - '.github/workflows/build-and-push.yml'

env:
  UPSTREAM_REPO: LmeSzinc/StarRailCopilot
  IMAGE_NAME: starrailcopilot

jobs:
  check-and-build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout æœ¬ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: æ£€æŸ¥ä¸Šæ¸¸ä»“åº“æ›´æ–°
        id: check_update
        run: |
          # èŽ·å–ä¸Šæ¸¸æœ€æ–° commit hash
          UPSTREAM_COMMIT=$(git ls-remote https://github.com/${{ env.UPSTREAM_REPO }}.git HEAD | cut -f1)
          echo "upstream_commit=$UPSTREAM_COMMIT" >> $GITHUB_OUTPUT
          echo "upstream_short=${UPSTREAM_COMMIT:0:7}" >> $GITHUB_OUTPUT
          
          # æ£€æŸ¥æœ¬åœ°è®°å½•
          if [ -f .last_build_commit ]; then
            LAST_COMMIT=$(cat .last_build_commit)
            echo "last_commit=$LAST_COMMIT" >> $GITHUB_OUTPUT
            
            if [ "$UPSTREAM_COMMIT" = "$LAST_COMMIT" ] && [ "${{ github.event_name }}" = "schedule" ]; then
              echo "has_update=false" >> $GITHUB_OUTPUT
              echo "âœ… æ— æ›´æ–°,è·³è¿‡æž„å»º"
            else
              echo "has_update=true" >> $GITHUB_OUTPUT
              echo "ðŸ”„ å‘çŽ°æ›´æ–°æˆ–æ‰‹åŠ¨è§¦å‘,å¼€å§‹æž„å»º"
            fi
          else
            echo "has_update=true" >> $GITHUB_OUTPUT
            echo "ðŸ†• é¦–æ¬¡æž„å»º"
          fi
      
      - name: å…‹éš†ä¸Šæ¸¸ä»“åº“
        if: steps.check_update.outputs.has_update == 'true'
        run: |
          git clone --depth 1 https://github.com/${{ env.UPSTREAM_REPO }}.git StarRailCopilot
          echo "âœ… å…‹éš†å®Œæˆ"
      
      - name: è®¾ç½® Docker Buildx
        if: steps.check_update.outputs.has_update == 'true'
        uses: docker/setup-buildx-action@v3
      
      - name: ç™»å½• Docker Hub
        if: steps.check_update.outputs.has_update == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: æå–å…ƒæ•°æ®
        if: steps.check_update.outputs.has_update == 'true'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest
            type=raw,value=${{ steps.check_update.outputs.upstream_short }}
            type=raw,value={{date 'YYYYMMDD'}}
      
      - name: æž„å»ºå¹¶æŽ¨é€ Docker é•œåƒ
        if: steps.check_update.outputs.has_update == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            COMMIT_HASH=${{ steps.check_update.outputs.upstream_commit }}
      
      - name: æ›´æ–°æž„å»ºè®°å½•
        if: steps.check_update.outputs.has_update == 'true'
        run: |
          echo "${{ steps.check_update.outputs.upstream_commit }}" > .last_build_commit
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .last_build_commit
          git commit -m "chore: update build record to ${{ steps.check_update.outputs.upstream_short }}"
          git push
      
      - name: è¾“å‡ºæž„å»ºä¿¡æ¯
        if: steps.check_update.outputs.has_update == 'true'
        run: |
          echo "### ðŸŽ‰ æž„å»ºæˆåŠŸ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ä¸Šæ¸¸ Commit**: \`${{ steps.check_update.outputs.upstream_commit }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **é•œåƒæ ‡ç­¾**: " >> $GITHUB_STEP_SUMMARY
          echo "  - \`${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "  - \`${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.check_update.outputs.upstream_short }}\`" >> $GITHUB_STEP_SUMMARY
          echo "  - \`${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:$(date +%Y%m%d)\`" >> $GITHUB_STEP_SUMMARY
